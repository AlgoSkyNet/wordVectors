---
title: "Vector Space Model Comparison"
author: "Ben Schmidt"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Comparing Word2Vec models

An important, but relatively undeveloped, aspect to exploratory data analysis on word embeddings is comparing multiple models to each other.

This vignette walks through two examples. The first is comparing a model to a modified version of itself built through vector *rejection*. The second compares two completely different models built through alignment.

```{r}
library(wordVectors)
library(dplyr)
library(tidyr)
library(ggplot2)
```

We'll start of by comparing a model to a slightly transformed version of itself.

```{r}
demo_vectors = demo_vectors %>% normalize_lengths()
genderless = demo_vectors %>% normalize_lengths %>% reject(~ "he" - "she") %>% reject(~ "man" - "woman") %>% normalize_lengths
```


This is a kind of wild thing that can be useful across different scenarios: it finds *synonyms* across a barrier.

```{r}

original_similarity = demo_vectors %>% cosineSimilarity(demo_vectors)
new_similarity = genderless %>% cosineSimilarity(genderless)

# Coerce from matrix to data.frame
pairings = data.frame(source=rep(rownames(original_similarity),ncol(original_similarity)),target=rep(colnames(original_similarity),each=nrow(original_similarity)),true_similarity=as.vector(original_similarity),genderless_similarity=as.vector(new_similarity),stringsAsFactors=FALSE)

library(dplyr)
pairings = pairings %>% 
  filter(source!=target) %>%
  group_by(source) %>% 
  mutate(source_rank=rank(-genderless_similarity)) %>%
  group_by(target) %>% 
  mutate(target_rank=rank(-genderless_similarity)) %>%
  mutate(share=((1-genderless_similarity)/(1-true_similarity))) %>% 
  mutate(label = paste(source,target,sep="->")) %>%
  # We don't need *everything*, and this saves memory.
  # But skip the filter for thoroughness.
  filter(source_rank<=100,target_rank<=100) %>%
  ungroup

pairings %>%
  filter(source_rank==1,target_rank==1) %>%
  group_by(source,target) %>%
  mutate(vector = list(demo_vectors[[source]]-demo_vectors[[target]])) %>%
  mutate(genderedness = {cosineSimilarity(demo_vectors[["he"]] - demo_vectors[["she"]], vector[[1]])}[1,1]) %>%
  filter(genderedness > 0) %>%
  ungroup %>%
  arrange(share) %>% head(15) %>% mutate(label = paste(source,target,sep=" -> ")) %>% select(label) %>% unlist %>% unname

```

```{r}


```


# Comparing *different* sets

```{r}
postwar <- read.vectors("~/Dropbox/hathi_word2vec/All_1945-1968.bin",nrow=50000)
prewar <- read.vectors("~/Dropbox/hathi_word2vec/All_1923-1945.bin",nrow=50000)

t1 = postwar %>% normalize_lengths %>% improve_vectorspace %>% nearest_to(~ "good",n=Inf,fancy_names=FALSE)
t2 = prewar %>% normalize_lengths %>% improve_vectorspace  %>% nearest_to(~ "good",n=Inf,fancy_names=FALSE)

nearest_to(improve_vectorspace(demo_vectors),"great")

#library(dplyr)
t1 %>% 
  inner_join(t2,by=c("word")) %>% 
  ggplot() + geom_point(aes(x=similarity.x,y=similarity.y),pch=1,alpha=.05)
  
mutate(xrank = rank(similarity.x))
  mutate(change = similarity.x - similarity.y) %>%
  arrange(change)


```

```{r}
pair = align_models(postwar,prewar)

postwar=pair[[1]]
prewar = pair[[2]]

usage_slopegraph(~"war",prewar,postwar,n=10)
```
