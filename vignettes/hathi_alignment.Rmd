---
title: "In-workshop materials"
output: html_document
---

## Introduction

```{r}
knitr::opts_chunk$set(eval=FALSE)
```

You need to download these files: they are big!

```{r}
library(wordVectors)
library(dplyr)

if (!dir.exists("~/vector_space_models")) dir.create("~/vector_space_models")

```


## Reading a list of files.

First, we want to read a *list* of files together. The "read_group" function in the package does this for us.

```{r}

model_names = list.files("~/vector_space_models/",full.names = T) %>% Filter(function(x) {grepl("(All_).*.bin",x)},.)
models = read_group(model_names,nrow=100000)

```


This new object is a named list; it can be accessed by index or by name. Some of the functions below use the names of the list, so it's worth getting them right.

```{r}
names(models)
with(models, `All_1923-1945` %>% nearest_to("Dakota"))
```

We can compare similarities between these models without aligning them by just looking at most-common words. The function `usage_slopegraph` can do this automatically; you can see, for example, a dramatic shift in the proximity to "Germany" of "Poland" and away from "Switzerland" in English-language texts.


```{r}
```

``` {r}

plot = with(models, usage_slopegraph("Germany", `All_1923-1945`, `All_1945-1968`))
plot
```

```{r}
plot + 
  geom_text(
    data = data.frame(label=oldlab1,y=struct[[1]][[1]]$y),
    x= 1-.1,
    aes(y=y,label=label),
    hjust=1
    )

struct 

struct[6,]
struct[[2]]
foo

foo[[1]]$labels


foo[[1]]
foo[[1]][[1]]$hjust=0
foo[[1]][[2]]$hjust=1

names()
layer_grob(foo[[3]])
foo$plot
foo
```

Or take "immigration", which over this same horizon moves into the neighbor of "refugees" and away from talk of "aliens."

``` {r}
with(models, usage_slopegraph("immigration", `All_1923-1945`, `All_1985-2010`))
```

These lists of words don't capture the underlying directions of movement, however. Suppose we want to ask "what words are similar to the vector along which Germany shifts?" 
One way to do these and other operations is to *align* models using a method called orthogonal procrustes: as used on word2vec, this was first described by Hamilton, Jurafsky, and Lescovic.

The function `align_models` does that for us here.

```{r}
aligned = align_models(models,shared_vocab_only = FALSE)
```

```{r}
changes_around_the_war = with(aligned,`All_1945-1968` - `All_1923-1945`)

changes_around_the_war %>% nearest_to(~"science")

german_change = with(aligned, `All_1945-1968`[["Germany"]] - `All_1923-1945`[["Germany"]])

aligned[["All_1923-1945"]] %>% nearest_to(german_change)

```

```{r}
stanford_plot(aligned, word = c("war"), 15, transform_type = "pca")
with(aligned, `All_1968-1985` %>% closest_to("homosexual",25))
```

```{r}

last = aligned[[6]]

last %>% nearest_to(~ "freedom" - "liberty", 30)

usage_slopegraph

last %>% nearest_to(~ -("freedom" - "liberty"), 50)
```

```{r}
stanford_plot(aligned, word = c("political"), 15, transform_type = "mds")
```

```{r}
stanford_plot(aligned, word = c("Rome"), 20, transform_type = "pca") + theme_bw()
```

A good one. The shift towards the modern sciences--especially the *social* sciences--is pronounced, but the entombment of science in the *university* is a later development.

```{r}
stanford_plot(aligned, word = c("physics","chemistry"), 15, transform_type = "pca") + theme_bw()
```

```{r}
stanford_plot(aligned, word = c("Russia"), 10, transform_type = "pca")
```


```{r}
stanford_plot(aligned, word = c("Negro"), 10, transform_type = "mds") + theme_bw()
```



```{r}
stanford_plot(aligned, word = c("hero"), 10, transform_type = "mds") + theme_bw()
```


```{r}
stanford_plot(aligned, word = c("masculine","feminine"), 10, transform_type = "mds") + theme_bw()
```

```{r}
stanford_plot(aligned, word = c("evolution"), 10, transform_type = "pca") + theme_bw()
```


```{r}
aligned = align_models(models,shared_vocab_only = TRUE)

change_matrix = lapply(2:length(aligned),function(i) {
  aligned[[i-1]] - aligned[[i]]
}) %>% do.call(cbind,.) %>% new("VectorSpaceModel",.)

multi_set = aligned %>% do.call(cbind,.) %>% new("VectorSpaceModel",.)

new("VectorSpaceModel",multi_set[,400:500]) %>% nearest_to("freedom")

aligned[[6]] %>% nearest_to("freedom")

```

```{r}

distance = function(mx,my) {sqrt(rowSums((mx - my)^2))}
distmat = sapply(1:length(aligned),function(i) {
  distance(aligned[[i]],aligned[[3]])
})

sort(-apply(distmat,1,mean))[1:100]
```


```{r}
stanford_plot(aligned,"liberty")

stanford_plot(aligned, word = c("tyranny"), 15, transform_type = "mds")

#Communism becomes taken *seriously*.
stanford_plot(aligned, word = c("communism"), 15, transform_type = "pca")

stanford_plot(aligned, word = c("English"), 15, transform_type = "pca")

stanford_plot(aligned, word = c("empire"), 15, transform_type = "pca")

stanford_plot(aligned, word = c("market"), 15, transform_type = "pca")

stanford_plot(aligned, word = c("economy"), 15, transform_type = "pca")


stanford_plot(aligned, word = c("empire"), 15, transform_type = "pca")

stanford_plot(aligned, word = c("king","queen"), 15, transform_type = "pca")

```


```{r}
stanford_plot(aligned, word = c("America"), 15, transform_type = "pca")
```
